#!/bin/bash

rofi='rofi -theme themes/dmenu.rasi'
wallpapers_dir="$XDG_PICTURES_DIR/wallpapers"
temp_dir="$wallpapers_dir/temp"
wallpaper="$XDG_PICTURES_DIR/wallpaper.jpg"
current_wallpaper="$(readlink -f "$wallpaper")"
position_file="/tmp/rofi-wallpaper-position"

options=(
    "󰇎 | random"
    "󰃭 | random from latest"
    "󰈈 | random from most viewed"
    "󰜸 | random from toplist"
    "󰓏 | random from favorites"
    "󰀼 | random from saved"
    "󰆓 | keep wallpaper"
    "󰃰 | last saved"
    " | delete current")

# Читаем последнюю позицию или используем 2 по умолчанию
if [ -f "$position_file" ]; then
    last_position=$(cat "$position_file")
else
    last_position=2
fi

chosen="$(printf '%s\n' "${options[@]}" | $rofi -p "wallpaper" -dmenu -selected-row "$last_position")"

# Сохраняем выбранную позицию (кроме delete current, keep wallpaper и last saved)
if [ -n "$chosen" ] &&
    [ "$chosen" != " | delete current" ] &&
    [ "$chosen" != "󰆓 | keep wallpaper" ] &&
    [ "$chosen" != "󰃰 | last saved" ]; then
    for i in "${!options[@]}"; do
        if [ "${options[$i]}" = "$chosen" ]; then
            echo "$i" > "$position_file"
            break
        fi
    done
fi

if [ -n "$chosen" ] && [ "$chosen" != "󰆓 | keep wallpaper" ]; then
    if [ "$(pgrep -c "$(basename "$0")")" -gt 1 ]; then
        notify-send "Please wait" && exit 1
    fi
fi

case $chosen in
"󰇎 | random") set-wallpaper "$(swd -l "$temp_dir")" ;;
"󰃭 | random from latest") set-wallpaper "$(swd -l "$temp_dir" -s date_added)" ;;
"󰈈 | random from most viewed") set-wallpaper "$(swd -l "$temp_dir" -s views)" ;;
"󰜸 | random from toplist") set-wallpaper "$(swd -l "$temp_dir" -s toplist)" ;;
"󰓏 | random from favorites") set-wallpaper "$(swd -l "$temp_dir" -s favorites)" ;;
"󰀼 | random from saved")
    mapfile -t wallpapers < <(find "$wallpapers_dir" -maxdepth 1 -type f)
    set-wallpaper "${wallpapers[$(("$RANDOM" % ${#wallpapers[@]}))]}"
    ;;
"󰆓 | keep wallpaper")
    PATTERN="$wallpapers_dir/*${current_wallpaper##*/}"

    # Проверяем имеется ли такое изображение
    if compgen -G "$PATTERN" >/dev/null; then
        notify-send "Image already exists"
    else
        # Генерируем название изображения
        img="$(date +%y%m%d-%H%M%S)-${current_wallpaper##*/}"

        # Сохраняем изображение
        cp "$current_wallpaper" "$wallpapers_dir/$img" && notify-send "$img saved"
    fi
    ;;
"󰃰 | last saved")
    set-wallpaper "$(find "$wallpapers_dir" -type f -maxdepth 1 | sort -n | tail -1)"
    ;;
" | delete current")
    # Удаляем текущее изображение
    if [ -f "$current_wallpaper" ]; then
        rm "$current_wallpaper"
    fi

    # Устанавливаем случайное из сохраненных
    mapfile -t wallpapers < <(find "$wallpapers_dir" -maxdepth 1 -type f)
    set-wallpaper "${wallpapers[$(("$RANDOM" % ${#wallpapers[@]}))]}"
    ;;
esac
#!/bin/bash

rofi='rofi -theme themes/dmenu.rasi'
wallpapers_dir="$XDG_PICTURES_DIR/wallpapers"
unvided_wallpapers_dir="$XDG_PICTURES_DIR/wallpapers_unviewed"
temp_dir="$wallpapers_dir/temp"
wallpaper="$XDG_PICTURES_DIR/wallpaper.jpg"
current_wallpaper="$(readlink -f "$wallpaper")"
position_file="/tmp/rofi-wallpaper-position"

# Подсчитываем количество непросмотренных изображений
unviewed_count=$(find "$unvided_wallpapers_dir" -type f \( \
    -iname "*.jpg" -o \
    -iname "*.jpeg" -o \
    -iname "*.png" \
\) ! -name "viewed_*" 2>/dev/null | wc -l)

options=(
    "󰇎 | random"
    "󰃭 | random from latest"
    "󰈈 | random from most viewed"
    "󰜸 | random from toplist"
    "󰓏 | random from favorites"
    "󰀼 | random from saved"
    "󰈖 | next unviewed ($unviewed_count)"
    "󰆓 | keep wallpaper"
    "󰃰 | last saved"
    " | delete current")

# Читаем последнюю позицию или используем 2 по умолчанию
if [ -f "$position_file" ]; then
    last_position=$(cat "$position_file")
else
    last_position=2
fi

chosen="$(printf '%s\n' "${options[@]}" | $rofi -p "wallpaper" -dmenu -selected-row "$last_position")"

# Сохраняем выбранную позицию (кроме delete current, keep wallpaper и last saved)
if [ -n "$chosen" ] &&
    [ "$chosen" != " | delete current" ] &&
    [ "$chosen" != "󰆓 | keep wallpaper" ] &&
    [ "$chosen" != "󰃰 | last saved" ]; then
    for i in "${!options[@]}"; do
        if [ "${options[$i]}" = "$chosen" ]; then
            echo "$i" > "$position_file"
            break
        fi
    done
fi

if [ -n "$chosen" ] && [ "$chosen" != "󰆓 | keep wallpaper" ]; then
    if [ "$(pgrep -c "$(basename "$0")")" -gt 1 ]; then
        notify-send "Please wait" && exit 1
    fi
fi

case $chosen in
"󰇎 | random") set-wallpaper "$(swd -l "$temp_dir")" ;;
"󰃭 | random from latest") set-wallpaper "$(swd -l "$temp_dir" -s date_added)" ;;
"󰈈 | random from most viewed") set-wallpaper "$(swd -l "$temp_dir" -s views)" ;;
"󰜸 | random from toplist") set-wallpaper "$(swd -l "$temp_dir" -s toplist)" ;;
"󰓏 | random from favorites") set-wallpaper "$(swd -l "$temp_dir" -s favorites)" ;;
"󰀼 | random from saved")
    mapfile -t wallpapers < <(find "$wallpapers_dir" -maxdepth 1 -type f)
    set-wallpaper "${wallpapers[$(("$RANDOM" % ${#wallpapers[@]}))]}"
    ;;
"󰈖 | next unviewed"*)
    # Получаем следующее непросмотренное изображение
    next_image=$(get-next-image "$unvided_wallpapers_dir")
    if [ -z "$next_image" ]; then
        notify-send "No more unviewed images"
    else
        set-wallpaper "$next_image"
    fi
    ;;
"󰆓 | keep wallpaper")
    # Создаем временную копию для обработки
    temp_file=$(mktemp)

    trap 'rm -f "$temp_file"' EXIT

    cp "$current_wallpaper" "$temp_file"

    # Удаляем метаданные через exiftool
    exiftool -all= -overwrite_original "$temp_file" >/dev/null 2>&1

    # Вычисляем md5sum
    md5_hash=$(md5sum "$temp_file" | cut -d' ' -f1)

    # Получаем расширение файла
    extension="${current_wallpaper##*.}"

    # Генерируем имя файла: дата-md5sum.расширение
    date_prefix=$(date +%y%m%d-%H%M%S)
    img="${date_prefix}-${md5_hash}.${extension}"

    # Проверяем наличие дубликата по md5sum в имени файла
    if compgen -G "$wallpapers_dir/*-${md5_hash}.${extension}" >/dev/null; then
        notify-send "Image already exists"
    else
        # Сохраняем изображение с новым именем
        mv "$temp_file" "$wallpapers_dir/$img" && notify-send "$img saved"
    fi
    ;;
"󰃰 | last saved")
    set-wallpaper "$(find "$wallpapers_dir" -type f -maxdepth 1 | sort -n | tail -1)"
    ;;
" | delete current")
    # Удаляем текущее изображение
    if [ -f "$current_wallpaper" ]; then
        rm "$current_wallpaper"
    fi

    # Устанавливаем случайное из сохраненных
    mapfile -t wallpapers < <(find "$wallpapers_dir" -maxdepth 1 -type f)
    set-wallpaper "${wallpapers[$(("$RANDOM" % ${#wallpapers[@]}))]}"
    ;;
esac
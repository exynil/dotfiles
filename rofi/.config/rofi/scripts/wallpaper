#!/bin/bash

rofi_command='rofi -theme themes/wallpaper.rasi'

options=("random"
    "random from latest"
    "random from most viewed"
    "random from toplist"
    "random from favorites"
    "random and blurred"
    "random from saved"
    "keep wallpaper"
    "last saved")

chosen="$(printf '%s\n' "${options[@]}" | $rofi_command -p "wallpaper" -dmenu -selected-row 2)"

if [ -n "$chosen" ]; then
    if [ "$(pgrep wallpaper | wc -l)" -gt 2 ]; then
        notify-send "Please wait"
        exit 1
    fi
fi

img_dir="$HOME/Pictures"

wallpapers_dir="$img_dir/wallpapers" && mkdir -p "$wallpapers_dir"

temp_dir="$wallpapers_dir/temp"

wallpaper="$img_dir/wallpaper.jpg"

set_wallpaper() {
    ln -sf "$1" "$wallpaper" && hsetroot -cover "$wallpaper"
}

case $chosen in
"random")
    img=$(swd -l "$temp_dir" -p 000)
    set_wallpaper "$img"
    ;;
"random from latest")
    img=$(swd -l "$temp_dir" -s date_added)
    set_wallpaper "$img"
    ;;
"random from most viewed")
    img=$(swd -l "$temp_dir" -s views)
    set_wallpaper "$img"
    ;;
"random from toplist")
    img=$(swd -l "$temp_dir" -s toplist)
    set_wallpaper "$img"
    ;;
"random from favorites")
    img=$(swd -l "$temp_dir" -s favorites)
    set_wallpaper "$img"
    ;;
"random and blurred")
    img=$(swd -l "$temp_dir")
    convert -blur 0x80 "$img" "$img"
    set_wallpaper "$img"
    ;;
"random from saved")
    mapfile -t wallpapers < <(find "$wallpapers_dir" -maxdepth 1 -type f)
    set_wallpaper "${wallpapers[$(("$RANDOM" % ${#wallpapers[@]}))]}"
    ;;
"keep wallpaper")
    # Получаем путь текущего изображения
    current_wallpaper="$(readlink -f "$wallpaper")"

    PATTERN="$wallpapers_dir/*${current_wallpaper##*/}"

    # Проверяем имеется ли такое изображение
    if compgen -G "$PATTERN" >/dev/null; then
        notify-send -u critical "Image already exists"
    else
        # Генерируем название изображения
        img="$(date +%y%m%d-%H%M%S)-${current_wallpaper##*/}"

        # Сохраняем изображение
        cp "$current_wallpaper" "$wallpapers_dir/$img" && notify-send "$img saved"
    fi
    ;;
"last saved")
    last_saved="$(find "$wallpapers_dir" -type f -printf "%f\n" | sort -n | tail -1)"
    set_wallpaper "$wallpapers_dir/$last_saved"
    ;;
esac
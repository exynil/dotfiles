#!/bin/bash

# Что делает этот скрипт:
# - Дешифрует и шифрует пароли созданные программой pass

# Define a help message
_help_message() {
    echo "ERROR. Must pass a single argument."
}

# Show the help message if arguments are not equal to one.
[ "$#" -eq 1 ] || { _help_message; exit 1; }

_decrypt() {
    password_store="$HOME/.password-store"

    if [ -d "$password_store/.decrypted" ]; then
        echo "Please, remove folder .decrypted first"
        exit 1
    fi

    folders=($(ls "$password_store"))

    for folder in "${folders[@]}"; do
        if [ ! -d "$password_store/.decrypted/$folder" ]; then
            mkdir -p "$password_store/.decrypted/$folder"
        fi
        
        passwords=($(find "$password_store/$folder" -name "*.gpg" | sed 's|.*/\([^/]*\)\.[^.]*$|\1|'))

        for password in "${passwords[@]}"; do
            pass "$folder/$password" > "$password_store/.decrypted/$folder/$password"
        done
    done
}


_encrypt() {
    password_store="$HOME/.password-store"
    decrypted_folder="$password_store/.decrypted"
    encrypted_folder="$password_store/.encrypted"

    if [ ! -d "$decrypted_folder" ]; then
        echo "Please, decrypted your passwords first"
        exit 1
    fi

    if [ -d "$encrypted_folder" ]; then
        echo "Please, remove folder .encrypted first"
        exit 1
    fi

    folders=($(ls "$decrypted_folder"))

    for folder in "${folders[@]}"; do
        if [ ! -d "$encrypted_folder/$folder" ]; then
            mkdir -p "$encrypted_folder/$folder"
        fi

        passwords=($(ls "$decrypted_folder/$folder"))

        for password in "${passwords[@]}"; do
            gpg -er "Maxim Kim" -o "$encrypted_folder/$folder/$password.gpg" "$decrypted_folder/$folder/$password" 
        done
    done
}

case $1 in
    "-d")
        _decrypt
        ;;
    "-e")
        _encrypt
        ;;
    *)
        exit 1
        ;;
esac

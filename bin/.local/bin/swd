#!/bin/bash

source "$XDG_CONFIG_HOME/swd/swd.conf"

params+="apikey=$(cat $apikey_file)"

while getopts ":C:a:p:c:r:s:o:l:" opt; do
  case ${opt} in
  C) params+="&colors=${OPTARG}" ;;
  a) params+="&atleast=${OPTARG}" ;;
  p) params+="&purity=${OPTARG}" ;;
  c) params+="&categories=${OPTARG}" ;;
  r) params+="&ratios=${OPTARG}" ;;
  s) params+="&sorting=${OPTARG}" ;;
  o) params+="&order=${OPTARG}" ;;
  l) location="${OPTARG}" && mkdir -p "$location" ;;
  \?) echo "Invalid option: -$OPTARG" >&2 && exit 1 ;;
  :) echo "Option -$OPTARG requires an argument." >&2 && exit 1 ;;
  esac
done

api_url="https://wallhaven.cc/api/v1/search?$params"

last_page=$(curl -s -L "$api_url" | jq -r '.meta.last_page')

api_url+="&page=$((1 + RANDOM % last_page))"

response=$(curl -s -L "$api_url")

index=$((RANDOM % 24))

wallpaper_url=$(echo "$response" | jq -r ".data[$index].path")
wallpaper_size=$(echo "$response" | jq -r ".data[$index].file_size")

wallpaper="$location/${wallpaper_url##*/}"

fdp "$wallpaper" "$wallpaper_size" &

curl -s -L "$wallpaper_url" -o "$wallpaper"

echo "$wallpaper"

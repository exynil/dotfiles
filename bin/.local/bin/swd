#!/bin/bash

source "$XDG_CONFIG_HOME/swd/swd.conf"

while getopts ":C:a:p:c:r:s:o:l:" opt; do
  case ${opt} in
  C) colors="${OPTARG}" ;;
  a) atleast="${OPTARG}" ;;
  p) purity="${OPTARG}" ;;
  c) categories="${OPTARG}" ;;
  r) ratios="${OPTARG}" ;;
  s) sorting="${OPTARG}" ;;
  o) order="${OPTARG}" ;;
  l) location="${OPTARG}" ;;
  \?) echo "Invalid option: -$OPTARG" >&2 && exit 1 ;;
  :) echo "Option -$OPTARG requires an argument." >&2 && exit 1 ;;
  esac
done

params+="apikey=$(cat $apikey_file)"
params+="&colors=$colors"
params+="&atleast=$atleast"
params+="&purity=$purity"
params+="&categories=$categories"
params+="&ratios=$ratios"
params+="&sorting=$sorting"
params+="&order=$order"

api_url="https://wallhaven.cc/api/v1/search?$params"

# Для random и toplist не нужно выбирать случайную страницу
# Для остальных сортировок выбираем случайную страницу из первых 5% (делим на 20)
if [ "$sorting" != "random" ] && [ "$sorting" != "toplist" ]; then
  last_page=$(curl -s -L "$api_url" | jq -r '.meta.last_page')
  max_page=$((last_page / 20))
  [ $max_page -lt 1 ] && max_page=1
  api_url+="&page=$((1 + RANDOM % max_page))"
fi

response=$(curl -s -L "$api_url")

# Выбираем случайный обои из результатов (максимум 24 на страницу)
index=$((RANDOM % 24))

# Извлекаем информацию о выбранном обои
wallpaper_url=$(jq -r ".data[$index].path" <<< "$response")
wallpaper_size=$(jq -r ".data[$index].file_size" <<< "$response")

# Получаем превью обоев
wallpaper_preview_url=$(jq -r ".data[$index].thumbs.small" <<< "$response")
wallpaper_preview="/tmp/swd/${wallpaper_preview_url##*/}"

# Скачиваем превью
curl --create-dirs -s -L "$wallpaper_preview_url" -o "$wallpaper_preview"

wallpaper="$location/${wallpaper_url##*/}"

# Выполняем pre_hook, если он задан
if [ -n "$pre_hook" ]; then
    eval "$pre_hook"
fi

curl --create-dirs -s -L "$wallpaper_url" -o "$wallpaper"

echo "$wallpaper"

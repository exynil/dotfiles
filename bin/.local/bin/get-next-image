#!/bin/bash

# Скрипт для получения следующего непросмотренного изображения
# Использование: get-next-image <путь_к_папке>
# Возвращает путь к изображению или пустую строку, если изображений больше нет

SEARCH_DIR="$1"

# Проверка аргументов
if [ -z "$SEARCH_DIR" ]; then
    echo "Ошибка: не указан путь к папке" >&2
    echo "Использование: $0 <путь_к_папке>" >&2
    exit 1
fi

# Проверка существования папки
if [ ! -d "$SEARCH_DIR" ]; then
    echo "Ошибка: папка '$SEARCH_DIR' не существует" >&2
    exit 1
fi

# Ищем первое непросмотренное изображение
# Исключаем файлы, начинающиеся с "viewed_" (уже обработанные)
# Используем sort для получения первого по алфавиту, head -1 останавливает после первого результата
image_path=$(find "$SEARCH_DIR" -type f \( \
    -iname "*.jpg" -o \
    -iname "*.jpeg" -o \
    -iname "*.png" \
\) ! -name "viewed_*" 2>/dev/null | LC_ALL=C sort | head -n 1)

# Если изображение не найдено
if [ -z "$image_path" ]; then
    # Возвращаем пустую строку
    exit 0
fi

# Получаем директорию и имя файла
dir=$(dirname "$image_path")
filename=$(basename "$image_path")

# Формируем новое имя с префиксом, который при сортировке уходит в конец
new_filename="viewed_$filename"
new_path="$dir/$new_filename"

# Переименовываем файл
mv "$image_path" "$new_path" 2>/dev/null
echo "$new_path"
exit 0

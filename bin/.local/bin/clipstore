#!/bin/bash

DB_DIR="$HOME/.local/share/clipstore"
DB_FILE="$DB_DIR/clipboard.db"

# Инициализация базы данных
init_db() {
    mkdir -p "$DB_DIR"
    sqlite3 "$DB_FILE" <<EOF
CREATE TABLE IF NOT EXISTS clipboard (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    pinned INTEGER DEFAULT 0,
    content TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
CREATE INDEX IF NOT EXISTS idx_pinned ON clipboard(pinned);
CREATE INDEX IF NOT EXISTS idx_created_at ON clipboard(created_at DESC);
EOF
}

# Сохранение данных в базу
store() {
    if [ ! -f "$DB_FILE" ]; then
        init_db
    fi
    local content
    content=$(cat)
    if [ -z "$content" ]; then
        exit 0
    fi
    # Кодируем содержимое в base64 для безопасного хранения
    local encoded_content
    encoded_content=$(printf '%s' "$content" | base64 | tr -d '\n')
    # Проверяем, не является ли это дубликатом последней записи
    local last_content
    last_content=$(sqlite3 "$DB_FILE" "SELECT content FROM clipboard ORDER BY id DESC LIMIT 1;" 2>/dev/null)
    if [ "$last_content" = "$encoded_content" ]; then
        # Это дубликат последней записи, пропускаем
        exit 0
    fi
    # Экранируем одинарные кавычки для SQL
    encoded_content=$(echo "$encoded_content" | sed "s/'/''/g")
    sqlite3 "$DB_FILE" "INSERT INTO clipboard (content) VALUES ('$encoded_content');"
}

# Получение списка записей
list() {
    if [ ! -f "$DB_FILE" ]; then
        init_db
    fi
    local limit=${1:-700}
    # Сначала закрепленные записи, затем обычные (новые сверху)
    sqlite3 -separator $'\t' "$DB_FILE" "
SELECT id, pinned, content FROM (
    SELECT id, pinned, content FROM clipboard WHERE pinned = 1
    UNION ALL
    SELECT id, pinned, content FROM clipboard WHERE pinned = 0 ORDER BY id DESC LIMIT $limit
) ORDER BY pinned DESC, id DESC;" | awk -F'\t' '{
    if (NF >= 3) {
        # Декодируем base64 из третьего поля
        cmd = "echo \"" $3 "\" | base64 -d 2>/dev/null"
        cmd | getline decoded
        close(cmd)
        if (decoded == "") decoded = $3
        print $1 "\t" $2 "\t" decoded
    }
}'
}

# Основная логика
case "$1" in
    store)
        store
        ;;
    list)
        list "$2"
        ;;
    *)
        echo "Использование: $0 {store|list} [limit]"
        exit 1
        ;;
esac

